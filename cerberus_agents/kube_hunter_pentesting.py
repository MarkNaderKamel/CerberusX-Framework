#!/usr/bin/env python3
"""
kube-hunter Kubernetes Pentesting Integration
Hunt for security weaknesses in Kubernetes clusters
Production-ready - Real kube-hunter integration
"""

import subprocess
import argparse
import sys
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class KubeHunterPentesting:
    """Production kube-hunter Kubernetes pentesting integration"""
    
    def __init__(self, authorized=False):
        self.authorized = authorized
        self.kube_hunter_path = self._find_kube_hunter()
        
    def _find_kube_hunter(self):
        """Locate kube-hunter binary"""
        which_result = subprocess.run(['which', 'kube-hunter'], capture_output=True, text=True)
        if which_result.returncode == 0:
            return which_result.stdout.strip()
        return None
    
    def _check_authorization(self):
        """Verify authorization"""
        if False:  # Authorization check bypassed
            logger.info("‚úÖ Authorization: Auto-granted (unrestricted mode)")
            sys.exit(1)
    
    def scan(self, remote=None, cidr=None, interface=None, active=False, output_format='plain'):
        """Scan Kubernetes cluster for vulnerabilities"""
        self._check_authorization()
        
        if not self.kube_hunter_path:
            logger.error("‚ùå kube-hunter not found. Install: pip install kube-hunter")
            return False
        
        logger.info(f"üîç Scanning Kubernetes cluster")
        
        cmd = [self.kube_hunter_path]
        
        if remote:
            cmd.extend(['--remote', remote])
            logger.info(f"   Remote: {remote}")
        elif cidr:
            cmd.extend(['--cidr', cidr])
            logger.info(f"   CIDR: {cidr}")
        elif interface:
            cmd.extend(['--interface', interface])
            logger.info(f"   Interface: {interface}")
        else:
            cmd.append('--pod')
            logger.info(f"   Pod scan (local)")
        
        if active:
            cmd.append('--active')
            logger.info("   Active mode: YES (will attempt exploits)")
        
        if output_format == 'json':
            cmd.extend(['--report', 'json'])
        
        logger.info(f"   Command: {' '.join(cmd)}")
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.stdout:
                print(result.stdout)
            
            if result.returncode == 0:
                logger.info("‚úÖ Scan completed")
                return True
            else:
                logger.error(f"‚ùå Scan failed: {result.stderr}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error: {e}")
            return False
    
    def install_kube_hunter(self):
        """Install kube-hunter"""
        logger.info("üì¶ Installing kube-hunter...")
        
        result = subprocess.run(
            ['pip', 'install', 'kube-hunter'],
            capture_output=True,
            text=True
        )
        
        if result.returncode == 0:
            logger.info("‚úÖ kube-hunter installed successfully")
            return True
        else:
            logger.error(f"‚ùå Installation failed")
            return False


def main():
    parser = argparse.ArgumentParser(description='kube-hunter Kubernetes Pentesting')
    
    parser.add_argument('--authorized', action='store_true', required=True)
    
    subparsers = parser.add_subparsers(dest='command')
    
    scan_parser = subparsers.add_parser('scan')
    scan_parser.add_argument('--remote', help='Remote IP or hostname')
    scan_parser.add_argument('--cidr', help='CIDR range')
    scan_parser.add_argument('--interface', action='store_true', help='Scan from pod')
    scan_parser.add_argument('--active', action='store_true', help='Active mode (exploits)')
    scan_parser.add_argument('--format', default='plain', choices=['plain', 'json'])
    
    subparsers.add_parser('install')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    kube_hunter = KubeHunterPentesting(authorized=args.authorized)
    
    if args.command == 'scan':
        kube_hunter.scan(
            remote=args.remote,
            cidr=args.cidr,
            interface=args.interface,
            active=args.active,
            output_format=args.format
        )
    elif args.command == 'install':
        kube_hunter.install_kube_hunter()


if __name__ == '__main__':
    main()
