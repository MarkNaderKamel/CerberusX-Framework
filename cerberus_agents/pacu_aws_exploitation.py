#!/usr/bin/env python3
"""
Pacu AWS Exploitation Framework
Advanced AWS post-exploitation and privilege escalation
Python-based framework for comprehensive cloud security testing
"""

import subprocess
import json
import os
import logging
from pathlib import Path
from typing import Dict, List, Optional

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class PacuAWSExploitation:
    """Production-ready Pacu framework for AWS security testing"""
    
    def __init__(self):
        self.pacu_path = self._find_pacu()
        self.pacu_dir = self._get_pacu_dir()
    
    def _find_pacu(self) -> Optional[str]:
        """Locate Pacu installation"""
        possible_paths = [
            str(Path.home() / "pacu" / "pacu.py"),
            "/opt/pacu/pacu.py",
            str(Path.home() / "pacu" / "cli.py"),
            "pacu"
        ]
        
        for path in possible_paths:
            if os.path.exists(path):
                return path
        
        if subprocess.run(["which", "pacu"], capture_output=True).returncode == 0:
            return "pacu"
        
        return None
    
    def _get_pacu_dir(self) -> Optional[str]:
        """Get Pacu working directory from installation path"""
        if not self.pacu_path:
            return None
        
        if self.pacu_path == "pacu":
            return None
        
        pacu_file = Path(self.pacu_path)
        if pacu_file.exists():
            return str(pacu_file.parent)
        
        return str(Path.home() / "pacu")
    
    def check_installation(self) -> Dict[str, any]:
        """Check Pacu installation"""
        result = {
            "installed": False,
            "path": None,
            "install_commands": [
                "git clone https://github.com/RhinoSecurityLabs/pacu.git ~/pacu",
                "cd ~/pacu",
                "bash install.sh",
                "python3 pacu.py"
            ]
        }
        
        if self.pacu_path:
            result["installed"] = True
            result["path"] = self.pacu_path
        
        return result
    
    def list_modules(self) -> List[Dict[str, any]]:
        """List available Pacu modules"""
        modules = {
            "iam": [
                "iam__enum_users_roles_policies_groups - Enumerate all IAM resources",
                "iam__privesc_scan - Scan for privilege escalation paths",
                "iam__backdoor_users_keys - Create backdoor access",
                "iam__bruteforce_permissions - Test IAM permission boundaries"
            ],
            "s3": [
                "s3__bucket_finder - Find and enumerate S3 buckets",
                "s3__download_bucket - Download bucket contents",
                "s3__bucket_acl_enum - Check bucket ACLs"
            ],
            "ec2": [
                "ec2__enum - Enumerate EC2 instances",
                "ec2__download_userdata - Extract user data scripts",
                "ec2__startup_shell_script - Execute commands on startup"
            ],
            "lambda": [
                "lambda__enum - Enumerate Lambda functions",
                "lambda__backdoor_new_roles - Backdoor Lambda execution roles"
            ],
            "secrets": [
                "secrets_manager__dump - Dump AWS Secrets Manager secrets",
                "ssm__get_parameters - Extract SSM Parameter Store values"
            ],
            "rds": [
                "rds__enum - Enumerate RDS databases",
                "rds__explore_snapshots - Find accessible snapshots"
            ],
            "cloudtrail": [
                "cloudtrail__download_event_history - Download CloudTrail logs",
                "cloudtrail__csv_injection - Inject malicious CSV payloads"
            ],
            "exfiltration": [
                "exfil__ec2_security_groups - Modify SGs for data exfil",
                "exfil__s3_bucket_dump - Exfiltrate S3 data"
            ]
        }
        
        return [{"category": cat, "modules": mods} for cat, mods in modules.items()]
    
    def run_module(self, module_name: str, session_name: str = "default",
                   region: str = None, params: str = "") -> Dict[str, any]:
        """
        Run Pacu module
        
        Args:
            module_name: Module to execute
            session_name: Pacu session name
            region: AWS region (optional)
            params: Additional module parameters
        """
        if not self.pacu_path:
            return {"error": "Pacu not installed"}
        
        commands = [
            f"set_session {session_name}",
            f"run {module_name} {params}".strip()
        ]
        
        if region:
            commands.insert(1, f"set_regions {region}")
        
        try:
            if self.pacu_path == "pacu":
                full_cmd = f"pacu -c '{'; '.join(commands)}'"
            else:
                if self.pacu_dir:
                    full_cmd = f"cd {self.pacu_dir} && python3 {Path(self.pacu_path).name} -c '{'; '.join(commands)}'"
                else:
                    full_cmd = f"python3 {self.pacu_path} -c '{'; '.join(commands)}'"
            
            output = subprocess.check_output(
                full_cmd,
                shell=True,
                stderr=subprocess.STDOUT,
                timeout=120
            ).decode()
            
            return {
                "success": True,
                "module": module_name,
                "session": session_name,
                "output": output
            }
        except subprocess.TimeoutExpired:
            return {"error": "Module execution timed out"}
        except Exception as e:
            return {"error": str(e)}
    
    def enum_iam(self, session_name: str = "default") -> Dict[str, any]:
        """Enumerate all IAM users, roles, policies, and groups"""
        return self.run_module("iam__enum_users_roles_policies_groups", session_name)
    
    def privesc_scan(self, session_name: str = "default") -> Dict[str, any]:
        """Scan for IAM privilege escalation paths"""
        return self.run_module("iam__privesc_scan", session_name)
    
    def find_s3_buckets(self, session_name: str = "default") -> Dict[str, any]:
        """Find and enumerate S3 buckets"""
        return self.run_module("s3__bucket_finder", session_name)
    
    def enum_ec2(self, session_name: str = "default", region: str = None) -> Dict[str, any]:
        """Enumerate EC2 instances"""
        return self.run_module("ec2__enum", session_name, region)
    
    def dump_secrets(self, session_name: str = "default") -> Dict[str, any]:
        """Dump AWS Secrets Manager secrets"""
        return self.run_module("secrets_manager__dump", session_name)
    
    def get_info(self) -> Dict[str, any]:
        """Get Pacu framework information"""
        return {
            "name": "Pacu AWS Exploitation Framework",
            "description": "Post-exploitation framework for AWS security testing",
            "developer": "Rhino Security Labs",
            "features": [
                "Comprehensive IAM enumeration",
                "Privilege escalation detection",
                "S3 bucket exploitation",
                "EC2 instance enumeration",
                "Lambda function backdoors",
                "Secrets Manager dumping",
                "CloudTrail log analysis",
                "Data exfiltration techniques",
                "RDS snapshot exploration",
                "Automated attack chains"
            ],
            "module_categories": [
                "IAM Exploitation",
                "S3 Security",
                "EC2 Enumeration",
                "Lambda Exploitation",
                "Secrets Extraction",
                "RDS Database Access",
                "CloudTrail Analysis",
                "Data Exfiltration"
            ],
            "github": "https://github.com/RhinoSecurityLabs/pacu",
            "requirements": ["boto3", "botocore", "Python 3.6+"],
            "attack_techniques": [
                "IAM privilege escalation (21 methods)",
                "S3 bucket enumeration and download",
                "EC2 metadata exploitation",
                "Lambda layer poisoning",
                "SSM parameter extraction",
                "Snapshot access abuse"
            ]
        }


def main():
    """CLI interface"""
    import argparse
    
    parser = argparse.ArgumentParser(description="Pacu AWS Exploitation Framework")
    parser.add_argument("--check", action="store_true", help="Check installation")
    parser.add_argument("--info", action="store_true", help="Show framework info")
    parser.add_argument("--list-modules", action="store_true", help="List all modules")
    parser.add_argument("--session", default="default", help="Pacu session name")
    parser.add_argument("--enum-iam", action="store_true", help="Enumerate IAM resources")
    parser.add_argument("--privesc-scan", action="store_true", help="Scan for privilege escalation")
    parser.add_argument("--find-s3", action="store_true", help="Find S3 buckets")
    parser.add_argument("--enum-ec2", action="store_true", help="Enumerate EC2 instances")
    parser.add_argument("--dump-secrets", action="store_true", help="Dump AWS Secrets")
    parser.add_argument("--region", help="AWS region")
    parser.add_argument('--authorized', action='store_true',
                       help='Confirm you have authorization to perform this action')
    args = parser.parse_args()
    
    pacu = PacuAWSExploitation()
    
    if args.check:
        status = pacu.check_installation()
        print("\n‚ïê‚ïê‚ïê Pacu Installation Status ‚ïê‚ïê‚ïê")
        print(f"Installed: {status['installed']}")
        if status['installed']:
            print(f"Path: {status['path']}")
        else:
            print(f"\nüì• Installation Commands:")
            for cmd in status['install_commands']:
                print(f"   {cmd}")
    
    elif args.info:
        info = pacu.get_info()
        print("\n‚ïê‚ïê‚ïê Pacu AWS Exploitation Framework ‚ïê‚ïê‚ïê")
        print(f"Name: {info['name']}")
        print(f"Developer: {info['developer']}")
        print(f"Description: {info['description']}")
        print(f"\nüéØ Features:")
        for feature in info['features']:
            print(f"   ‚Ä¢ {feature}")
        print(f"\n‚öîÔ∏è Attack Techniques:")
        for technique in info['attack_techniques']:
            print(f"   ‚Ä¢ {technique}")
        print(f"\nüîó GitHub: {info['github']}")
    
    elif args.list_modules:
        modules = pacu.list_modules()
        print("\nüì¶ Pacu Modules by Category:")
        for category in modules:
            print(f"\n{category['category'].upper()}:")
            for module in category['modules']:
                print(f"   ‚Ä¢ {module}")
    
    elif args.enum_iam:
        print(f"\nüîç Enumerating IAM resources (session: {args.session})...")
        result = pacu.enum_iam(args.session)
        if "success" in result:
            print("‚úÖ IAM enumeration complete")
            print(result.get('output', ''))
        else:
            print(f"‚ùå Error: {result.get('error')}")
    
    elif args.privesc_scan:
        print(f"\nüéØ Scanning for privilege escalation paths...")
        result = pacu.privesc_scan(args.session)
        if "success" in result:
            print("‚úÖ Privilege escalation scan complete")
        else:
            print(f"‚ùå Error: {result.get('error')}")
    
    elif args.find_s3:
        print(f"\nü™£ Finding S3 buckets...")
        result = pacu.find_s3_buckets(args.session)
        if "success" in result:
            print("‚úÖ S3 enumeration complete")
        else:
            print(f"‚ùå Error: {result.get('error')}")
    
    elif args.enum_ec2:
        print(f"\nüíª Enumerating EC2 instances...")
        result = pacu.enum_ec2(args.session, args.region)
        if "success" in result:
            print("‚úÖ EC2 enumeration complete")
        else:
            print(f"‚ùå Error: {result.get('error')}")
    
    elif args.dump_secrets:
        print(f"\nüîê Dumping AWS Secrets Manager...")
        result = pacu.dump_secrets(args.session)
        if "success" in result:
            print("‚úÖ Secrets dump complete")
        else:
            print(f"‚ùå Error: {result.get('error')}")
    
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
